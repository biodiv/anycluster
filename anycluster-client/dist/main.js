function e(e,t,r,s){Object.defineProperty(e,t,{get:r,set:s,enumerable:!0,configurable:!0})}let t;var r;let s;var i;let o;var n;let a;var h;let l;var d;e(module.exports,"ClusterMethod",(()=>s)),e(module.exports,"GeometryType",(()=>o)),e(module.exports,"IconType",(()=>a)),e(module.exports,"SRIDS",(()=>t)),e(module.exports,"Anycluster",(()=>u)),e(module.exports,"AnyclusterClient",(()=>p)),(r=t||(t={})).EPSG4326="EPSG:4326",r.EPSG3857="EPSG:3857",(i=s||(s={})).kmeans="kmeans",i.grid="grid",(n=o||(o={})).viewport="viewport",n.area="area",(h=a||(a={})).exact="exact",h.rounded="rounded",(d=l||(l={}))[d.grid=64]="grid",d[d.kmeans=150]="kmeans";const m={1:[24,39],5:[30,30],10:[30,30],50:[40,40],100:[40,40],1e3:[50,50],1e4:[60,60]},c=Object.freeze({minX:-179,maxX:179,minY:-89,maxY:89}),g=Object.freeze({minX:-20037500,maxX:20037500,minY:-20048960,maxY:20048960});class u{constructor(e,r,s){if(this.apiUrl=e,this.gridSize=r,this.srid=s,this.filters=[],this.srid==t.EPSG4326)this.maxBounds=c;else{if(this.srid!=t.EPSG3857)throw new Error(`invalid srid given: ${this.srid} `);this.maxBounds=g}}async getGridCluster(e,t){const r=`${this.apiUrl}grid/${e}/${this.gridSize}/`;return await this.post(r,t)}async getKmeansCluster(e,t){const r=`${this.apiUrl}kmeans/${e}/${this.gridSize}/`;return await this.post(r,t)}async getKmeansClusterContent(e,t){const r=`${this.apiUrl}get-kmeans-cluster-content/${e}/${this.gridSize}/`;return await this.post(r,t)}async getDatasetContent(e,t){const r=`${this.apiUrl}get-dataset-content/${e}/${this.gridSize}/${t}/`;return await this.get(r)}getAreaContent(){}addFilters(){}removeFilters(){}viewportToGeoJSON(e){const t=Math.max(e.left,this.maxBounds.minX),r=Math.min(e.right,this.maxBounds.maxX),s=Math.min(e.top,this.maxBounds.maxY),i=Math.max(e.bottom,this.maxBounds.minY);return{type:"Feature",geometry:{type:"Polygon",coordinates:[[[t,s],[r,s],[r,i],[t,i],[t,s]]],crs:{type:"name",properties:{name:this.srid}}}}}async post(e,t){const r=encodeURI(e),s={method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"},mode:"cors",credentials:"include"},i=await fetch(r,s),o=await i.json();if(i.ok)return o;throw new Error(JSON.stringify(o))}async get(e){const t=encodeURI(e),r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors",credentials:"include"}),s=await r.json();if(r.ok)return s;throw new Error(JSON.stringify(s))}}class p{constructor(e,r,i,n){this.map=e,this.apiUrl=r,this.markerFolderPath=i,this.filters=[],this.map=e,this.apiUrl=r,this.markerFolderPath=i,n=n||{},this.srid=n.srid?n.srid:t.EPSG4326,this.kmeansGridSize=n.gridGridSize?n.gridGridSize:l.kmeans,this.gridGridSize=n.gridGridSize?n.gridGridSize:l.grid,this.clusterMethod=n.clusterMethod?n.clusterMethod:s.kmeans,this.geometryType=n.geometryType?n.geometryType:o.viewport,this.area=n.area?n.area:null,this.iconType=n.iconType?n.iconType:a.rounded,this.onFinalClick=n.onFinalClick?n.onFinalClick:this._onFinalClick,this.singlePinImages=n.singlePinImages?n.singlePinImages:{},this.markerImageSizes=n.markerImageSizes?n.markerImageSizes:m,this.area&&this.setArea(this.area);const h=this.getGridSize();this.anycluster=new u(this.apiUrl,h,this.srid),this.createClusterLayers(),this.markerList=[],this.startClustering()}createClusterLayers(){throw new Error("NotImplementedError: createClusterLayers")}addArea(e){throw new Error("NotImplementedError: addArea")}removeArea(){throw new Error("NotImplementedError: removeArea")}removeAllMarkers(){throw new Error("NotImplementedError: removeAllMarkers")}getZoom(){throw new Error("NotImplementedError: getZoom")}setMap(e,t,r){throw new Error("NotImplementedError: setMap")}getViewport(){throw new Error("NotImplementedError: setMap")}addMapEventListeners(){throw new Error("NotImplementedError: addMapEventListeners")}drawMarker(e){throw new Error("NotImplementedError: drawMarker")}drawCell(e){throw new Error("NotImplementedError: drawCell")}getAreaContent(e){throw new Error("NotImplementedError: getAreaContent")}getGridSize(){return this.clusterMethod==s.grid?this.gridGridSize:this.kmeansGridSize}setClusterMethod(e){e==s.grid&&(this.area=null,this.geometryType=o.viewport,this.removeArea()),this.removeAllMarkers(),this.clusterMethod=e;const t=this.getGridSize();this.anycluster=new u(this.apiUrl,t,this.srid),this.markerList=[],this.getClusters(!0)}setArea(e){this.area=e,this.removeArea(),null==e?(this.geometryType=o.viewport,this.setClusterMethod(s.kmeans)):(this.addArea(e),this.geometryType=o.area,this.setClusterMethod(s.kmeans))}getSinglePinImageURL(e){const t=e.pinimg;let r=`${this.markerFolderPath}pin_unknown.png`;return this.singlePinImages&&t&&t in this.singlePinImages&&(r=this.singlePinImages[t]),r}selectPinIcon(e){const t=e.count;let r=this.getSinglePinImageURL(e),s="1";t>1e4?s="10000":t>1e3?s="1000":t>100?s="100":t>50?s="50":t>10?s="10":t>1&&(s="5"),t>1&&(r=this.iconType==a.exact?`${this.markerFolderPath}${s}_empty.png`:`${this.markerFolderPath}${s}.png`);const i=this.markerImageSizes[s];let o=[Math.round(i[0]/2),i[1]-1],n=[.5,1];t>1&&(o=[Math.round(i[0]/2),Math.round(i[1]/2)],n=[.5,.5]);return{url:r,size:i,anchor:o,relativeAnchor:n,popupAnchor:[0,8-Math.round(i[1])]}}setMarkerProps(e,t){return e.x=t.center.x,e.y=t.center.y,e.count=t.count,t.hasOwnProperty("ids")&&(e.ids=t.ids),t.hasOwnProperty("id")&&(e.id=t.id),t.hasOwnProperty("geojson")&&(e.geojson=t.geojson),e}markerClickFunction(e,t){this.removeAllMarkers();let r=this.getZoom();r+=3,this.setMap(e,t,r)}async onMarkerFinalClick(e){const t=this.getZoom(),r=e.x,i=e.y,o=e.ids;if(this.clusterMethod==s.kmeans){const s={geometry_type:this.geometryType,input_srid:this.srid,x:r,y:i,ids:o,filters:this.filters},n=await this.anycluster.getKmeansClusterContent(t,s);this.onFinalClick(e,n)}else if(this.clusterMethod=s.grid)if(1==e.count){const r=await this.anycluster.getDatasetContent(t,e.id);this.onFinalClick(e,r)}else{const t=e.geojson,r=await this.getAreaContent(t);this.onFinalClick(e,r)}}roundMarkerCount(e){return e=1==e?1:e<=5?5:e<=10?10:e<=50?50:e<=100?100:e<=1e3?1e3:1e4}getClusterGeometry(){let e;if(this.geometryType==o.viewport){const t=this.getViewport();e=this.anycluster.viewportToGeoJSON(t)}else{if(this.geometryType!=o.area||!this.area)throw new Error("No cluster geometry found");e=this.area}return e}async getClusters(e=!1){const t=this.getClusterGeometry(),r={output_srid:this.srid,geometry_type:this.geometryType,geojson:t,clear_cache:e},i=this.getZoom();if(this.clusterMethod==s.kmeans){const e=await this.anycluster.getKmeansCluster(i,r);e.length>0&&e.forEach((e=>{this.drawMarker(e)}))}else{if(this.clusterMethod!=s.grid)throw new Error(`Invalid clusterMethod: ${this.clusterMethod}`);{const e=await this.anycluster.getGridCluster(i,r);e.length>0&&e.forEach((e=>{this.drawCell(e)}))}}}startClustering(){this.getClusters(!0),this.addMapEventListeners()}_onFinalClick(e,t){alert(JSON.stringify(t))}}
//# sourceMappingURL=main.js.map
